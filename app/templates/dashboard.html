{% extends "base.html" %}

{% block title %}Dashboard{% endblock %}

{% block content %}
<div class="container">
    <!-- Welcome Section -->
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="display-5 mb-4">Welcome, {{ current_user.full_name or current_user.username }}!</h1>
        </div>
    </div>

    <!-- Feedback Status Message -->
    <div id="feedback-status" class="alert" style="display: none;"></div>

    <!-- Quick Actions -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Quick Actions</h5>
                    <a href="{{ url_for('main.request_feedback') }}" class="btn btn-primary">
                        <i class="bi bi-plus-circle"></i> Request Feedback
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Feedback Requests -->
    <div class="row">
        <!-- Pending Requests -->
        <div class="col-md-6 mb-4">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="mb-0">Pending Requests</h5>
                </div>
                <div class="card-body">
                    {% if pending_requests %}
                        <div class="list-group">
                            {% for request in pending_requests %}
                                <div class="list-group-item">
                                    <h6 class="mb-1">{{ request.request_recipient }}</h6>
                                    <p class="mb-1 text-muted">{{ request.recipient_email }}</p>
                                    <small>Sent: {{ request.created_at.strftime('%Y-%m-%d') }}</small>
                                    <button onclick="showDetails({{ request.id }})" class="btn btn-sm btn-outline-primary float-end">
                                        Details
                                    </button>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <p class="text-muted">No pending requests</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Completed Requests -->
        <div class="col-md-6 mb-4">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="mb-0">Completed Requests</h5>
                </div>
                <div class="card-body">
                    {% if completed_requests %}
                        <div class="list-group">
                            {% for request in completed_requests %}
                                <div class="list-group-item">
                                    <h6 class="mb-1">{{ request.request_recipient }}</h6>
                                    <p class="mb-1 text-muted">{{ request.recipient_email }}</p>
                                    <small>Completed: {{ request.updated_at.strftime('%Y-%m-%d') }}</small>
                                    <button onclick="showDetails({{ request.id }})" class="btn btn-sm btn-outline-primary float-end">
                                        Details
                                    </button>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <p class="text-muted">No completed requests</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Details Modal -->
<div class="modal fade" id="feedback-details" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Feedback Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Details will be loaded here -->
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    function showDetails(requestId) {
        fetch(`/feedback/${requestId}`)
            .then(response => response.json())
            .then(data => {
                const modalBody = document.querySelector('#feedback-details .modal-body');
                modalBody.innerHTML = `
                    <p><strong>Recipient:</strong> ${data.request_recipient}</p>
                    <p><strong>Email:</strong> ${data.recipient_email}</p>
                    <p><strong>Status:</strong> ${data.status}</p>
                    <p><strong>Created:</strong> ${new Date(data.created_at).toLocaleDateString()}</p>
                    ${data.feedback ? `<p><strong>Feedback:</strong> ${data.feedback}</p>` : ''}
                `;
                new bootstrap.Modal(document.getElementById('feedback-details')).show();
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to load feedback details');
            });
    }

    function showStatus(message, type) {
        const statusDiv = document.getElementById('feedback-status');
        statusDiv.className = `alert alert-${type}`;
        statusDiv.textContent = message;
        statusDiv.style.display = 'block';
        
        setTimeout(() => {
            statusDiv.style.display = 'none';
        }, 5000);
    }
</script>
{% endblock %}
